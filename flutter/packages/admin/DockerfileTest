#
# This software is in the public domain under CC0 1.0 Universal plus a
# Grant of Patent License.
# 
# To the extent possible under law, the author(s) have dedicated all
# copyright and related and neighboring rights to this software to the
# public domain worldwide. This software is distributed without any
# warranty.
# 
# You should have received a copy of the CC0 Public Domain Dedication
# along with this software (see the LICENSE.md file). If not, see
# <http://creativecommons.org/publicdomain/zero/1.0/>.
#

#Stage 1 - Install dependencies and build the app
FROM mobiledevops/flutter-sdk-image AS build-env
MAINTAINER GrowERP <support@growerp.com>

ARG BRANCH=development # currently either master or development we need to add existing
USER root
# Install linux dependencies
RUN apt-get update && \
    apt-get install -y git zip libgconf-2-4 adb libstdc++6 adb \
        fonts-droid-fallback nano && \
    apt-get clean

# git security
RUN git config --system --add safe.directory '*'
RUN git config --global --add safe.directory /home/mobiledevops/.flutter-sdk

# activate melos
RUN dart pub global activate melos
ENV PATH="$PATH":"$HOME/.pub-cache/bin"

# get growerp repos
USER mobiledevops
WORKDIR /home/mobiledevops
RUN git clone --depth 1 -b $BRANCH https://github.com/growerp/growerp.git
#RUN dart pub global run melos:melos clean
WORKDIR /home/mobiledevops/growerp/flutter
RUN melos bootstrap
# localization
RUN melos l10n --no-select
# build
RUN melos build_all --no-select
# build flutter app
WORKDIR /home/mobiledevops/growerp/flutter/packages/admin
#RUN curl -s https://developer.android.com/studio\#command-tools | grep -Eo 'https://dl.google.com/android/repository/commandlinetools-linux-[0-9]*_latest.zip' | head -n 1 | xargs wget
#RUN unzip commandlinetools-linux-9477386_latest.zip
#RUN sdkmanager "build-tools;29.0.2"
CMD ["adb", "connect". "emulator:5555" ,"&&","flutter","test"."integration_test"]

