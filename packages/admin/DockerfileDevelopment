#
# This software is in the public domain under CC0 1.0 Universal plus a
# Grant of Patent License.
# 
# To the extent possible under law, the author(s) have dedicated all
# copyright and related and neighboring rights to this software to the
# public domain worldwide. This software is distributed without any
# warranty.
# 
# You should have received a copy of the CC0 Public Domain Dedication
# along with this software (see the LICENSE.md file). If not, see
# <http://creativecommons.org/publicdomain/zero/1.0/>.
#

#Stage 1 - Install dependencies and build the app
FROM debian:latest AS build-env

# Install flutter dependencies
RUN apt-get update && \
    apt-get install -y curl git wget zip unzip libgconf-2-4 gdb libstdc++6 \
        libglu1-mesa adb fonts-droid-fallback lib32stdc++6 nano && \
    apt-get clean

# Clone the flutter repo
RUN git clone -b stable --depth 1 https://github.com/flutter/flutter.git /usr/local/flutter && \
    /usr/local/flutter/bin/flutter doctor -v
ENV PATH="/usr/local/flutter/bin:/usr/local/flutter/bin/cache/dart-sdk/bin:${PATH}"

# set flutter channel
RUN flutter channel stable && flutter upgrade
#get melos
RUN dart pub global activate melos
ENV PATH="/root/.pub-cache/bin:${PATH}"
# get growerp repos
RUN git clone --depth 1 -b development https://github.com/growerp/growerp.git /usr/local/growerp
WORKDIR /usr/local/growerp/
#RUN dart pub global run melos:melos clean
RUN melos bootstrap
# localization
RUN melos l10n
# get growerp_core first, other are dependent on it
RUN melos build_all 
# build flutter app
RUN git config --global --add safe.directory /usr/local/flutter
WORKDIR /usr/local/growerp
CMD bash
